
path = fullfile(matlabroot,'toolbox','nnet','nndemos','nndatasets','DigitDataset');
imds = imageDatastore(path,'IncludeSubfolders',true,'LabelSource','foldernames');

minCount = min(countEachLabel(imds).Count);
imds = splitEachLabel(imds,minCount,'randomize');
imds.ReadFcn = @(f) imresize(imread(f),[28 28]);

[trainFull,test] = splitEachLabel(imds,0.7,'randomized');
[train,val] = splitEachLabel(trainFull,0.85,'randomized');  % 85% train, 15% val

layers = [
    imageInputLayer([28 28 1])
    convolution2dLayer(3,8,'Padding','same')
    batchNormalizationLayer
    reluLayer
    maxPooling2dLayer(2,'Stride',2)
    convolution2dLayer(3,16,'Padding','same')
    batchNormalizationLayer
    reluLayer
    maxPooling2dLayer(2,'Stride',2)
    fullyConnectedLayer(64)
    reluLayer
    fullyConnectedLayer(10)
    softmaxLayer
    classificationLayer
];

opts = trainingOptions('adam', ...
    'MaxEpochs',6, ...
    'MiniBatchSize',64, ...
    'Shuffle','every-epoch', ...
    'ValidationData',val, ...
    'Verbose',false, ...
    'Plots','training-progress');

net = trainNetwork(train,layers,opts);

YPred = classify(net,test);
acc = mean(YPred == test.Labels);
fprintf('\nTest Accuracy: %.2f%%\n', acc*100);

figure;
confusionchart(test.Labels,YPred);
title('Confusion Matrix - CNN Test Data');
